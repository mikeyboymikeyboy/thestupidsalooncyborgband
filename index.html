<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>The Stupid Saloon Cyborg Band</title>
    <script src="https://cdn.jsdelivr.net/npm/svg2pdf.js@2.1.4/dist/svg2pdf.umd.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
        @font-face {
            font-family: 'IM Fell English';
            src: url('IMFellEnglish.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }

        body,
        #text,
        button,
        .prompt,
        .option,
        .title {
            font-family: 'IM Fell English', serif !important;
        }

        body {
            font-family: "IM Fell English", serif;
            background: black;
            color: white;
            text-align: center;
            padding: 2em;
font-size: 1.5em;
        }

        img {
            max-width: 90%;
            height: auto;
            margin-bottom: 1em;
        }

        .button {
            display: inline-block;
            background: linear-gradient(to bottom, #3e2f23, #2a1f16);
            border: 1px solid #a57c57;
            border-radius: 4px;
            color: #f4e7d0;
            font-family: 'IM Fell English', serif;
            letter-spacing: 0.5px;
            padding: 10px 16px;
            margin: 1em;
            cursor: pointer;
            box-shadow: inset 0 0 4px #00000088, 0 0 6px #3defff44;
            transition: all 0.2s ease-in-out;
            font-size: 1em;
        }

        .button:hover {
            background: #4c372a;
            border-color: #ffc56f;
            box-shadow: inset 0 0 6px #000000aa, 0 0 10px #00ffe655;
            transform: translateY(-1px);
        }

        .button:active {
            transform: scale(0.97);
            box-shadow: inset 0 0 3px #000000cc, 0 0 4px #ffaa0088;
        }

        .button.waiting {
            animation: pulse 1.2s ease-in-out infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 6px #3defff33;
                background-color: #3e2f23;
            }

            50% {
                box-shadow: 0 0 20px #3defffbb;
                background-color: #4c372a;
            }

            100% {
                box-shadow: 0 0 6px #3defff33;
                background-color: #3e2f23;
            }
        }
    
.image-text-container {
  display: flex;
  align-items: flex-start;
  justify-content: center;
  gap: 2em;
  margin-bottom: 1.5em;
  flex-wrap: wrap;
}
.image-text-container img {
  max-width: 100%;
  height: auto;
}
.text-block {
  max-width: 600px;
  text-align: left;
}


@media (max-width: 768px) {
  .image-text-container {
    flex-direction: column;
    align-items: center;
  }
  .text-block {
    text-align: center;
  }
}


@media (max-width: 768px) {
  body {
    font-size: 1.875em; /* 25% bigger than original 1.5em */
  }
  .image-text-container {
    flex-direction: column;
    align-items: center;
    gap: 2.5em;
  }
  .text-block {
    text-align: center;
  }
  .button {
    padding: 12px 20px;
    font-size: 1.25em;
  }
}


.fade-in {
  opacity: 0;
  transition: opacity 0.8s ease-in;
}
.fade-in.loaded {
  opacity: 0.4;
}




.scrolling-container {
  height: 300px;
  overflow: hidden;
  position: relative;
  width: 100%;
  margin: 2em auto;
}

.scrolling-inner {
  position: relative;
  text-align: center;
  white-space: pre-line;
}

}

}


.scrolling-preview {
  position: absolute;
  
  left: 10px;
  z-index: 5;
  pointer-events: none;
}

.scrolling-preview img {
  max-height: 200px;
  border: 2px solid red;
  opacity: 0.4;
}








.slideshow-container {
  position: fixed;
  
  max-height: 400px;
  width: 400px;
  pointer-events: none;
  z-index: 0;
  animation: floatUp 6s ease-in-out infinite alternate;
}

.slideshow-container.left-fixed {
  left: 60px;
}

.slideshow-container.right {
  right: 60px;
}

.slideshow-image {
  max-height: 400px;
  width: auto;
  opacity: 0;
  transition: opacity 4s ease-in-out;
}

.slideshow-image.visible {
  opacity: 0.4;
}


@keyframes floatUp {
  0% { transform: translateY(0); }
  100% { transform: translateY(-20px); }
}

@keyframes floatDown {
  0% { transform: translateY(0); }
  100% { transform: translateY(20px); }
}

@keyframes floatLeft {
  0% { transform: translateX(0); }
  100% { transform: translateX(-20px); }
}

@keyframes floatRight {
  0% { transform: translateX(0); }
  100% { transform: translateX(20px); }
}

@keyframes floatDiagonalLeft {
  0% { transform: translate(0, 0); }
  100% { transform: translate(-20px, -20px); }
}

@keyframes floatDiagonalRight {
  0% { transform: translate(0, 0); }
  100% { transform: translate(20px, -20px); }
}

.floatUp         { animation: floatUp 6s ease-in-out infinite alternate; }
.floatDown       { animation: floatDown 6s ease-in-out infinite alternate; }
.floatLeft       { animation: floatLeft 6s ease-in-out infinite alternate; }
.floatRight      { animation: floatRight 6s ease-in-out infinite alternate; }
.floatDiagonalLeft  { animation: floatDiagonalLeft 6s ease-in-out infinite alternate; }
.floatDiagonalRight { animation: floatDiagonalRight 6s ease-in-out infinite alternate; }

  100% { transform: translateY(-20px); }
}

  100% { transform: translateY(-20px); }
}

  100% { transform: translateY(-20px); }
}





</style>
</head>

<body>
    
    <div id="game">
        <p>Loading story...</p>
    </div>
    <!-- Comic Export Support -->
<div id="comic-export-container" style="display:none;"></div>
<script>


function generateComicSVG(images) {
    const svgNS = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("width", "210mm");
    svg.setAttribute("height", "297mm");
    svg.setAttribute("viewBox", "0 0 2048 2860");

    images.slice(0, 5).forEach((url, i) => {
        const img = document.createElementNS(svgNS, "image");
        img.setAttributeNS(null, "href", url);
        img.setAttributeNS(null, "preserveAspectRatio", "xMidYMid slice");
        if (i === 0) img.setAttribute("x", -76), img.setAttribute("y", 169), img.setAttribute("width", 1110), img.setAttribute("height", 992);
        if (i === 1) img.setAttribute("x", 436), img.setAttribute("y", 170), img.setAttribute("width", 1756), img.setAttribute("height", 993);
        if (i === 2) img.setAttribute("x", 1183), img.setAttribute("y", 1027), img.setAttribute("width", 939), img.setAttribute("height", 1118);
        if (i === 3) img.setAttribute("x", -101), img.setAttribute("y", 1014), img.setAttribute("width", 1442), img.setAttribute("height", 1291);
        if (i === 4) img.setAttribute("x", -184), img.setAttribute("y", 1922), img.setAttribute("width", 2431), img.setAttribute("height", 1022);
        svg.appendChild(img);
    });

    return svg;
}

function exportComicPDF(images) {
    console.log("💥 Comic export triggered!", images);
    const container = document.getElementById("comic-export-container");
    container.innerHTML = '';
    const svg = generateComicSVG(images);
    container.appendChild(svg);

    setTimeout(() => {
        const jsPDF = window.jspdf?.jsPDF;
        const svg2pdf = window["svg2pdf"];
        if (!jsPDF || !svg2pdf) {
            console.error("❌ PDF export libraries not loaded");
            return;
        }

        const pdf = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });

        svg2pdf(svg, pdf, { xOffset: 0, yOffset: 0, scale: 0.25 })
            .then(() => {
                console.log("📄 PDF ready, saving...");
                pdf.save("your-cybersaloon-comic.pdf");
            })
            .catch(err => console.error("⚠️ PDF generation failed:", err));
    }, 500);

            }
        }

        function handleChoice(nextId) {
    const selectedChoice = currentScene.choices.find(c => c.next === nextId);

    if (isLoopingScene) {
        choiceMade = nextId;

        const buttons = document.querySelectorAll(".button");
        buttons.forEach(btn => {
            if (btn.textContent === selectedChoice?.label) {
                btn.classList.add("waiting");
            }
        });

        if (currentSource) {
            currentSource.loop = false;
            return; // Let the normal audio finish and trigger the transition
        }

        if (currentMultiAudio) {
            // Fade out multi-audio and go to next scene after short pause
            for (let label in multiAudioGains) {
                multiAudioGains[label].gain.setTargetAtTime(0, audioContext.currentTime, 0.2);
            }

            setTimeout(() => {
                stopMultiAudio();
                showScene(choiceMade);
                choiceMade = null;
            }, 1000);

            return;
        }
    }

    showScene(nextId);
}


        
function preloadImages(imageUrls) {
    imageUrls.forEach(url => {
        const img = new Image();
        img.src = url;
    });
}


async function loadStory() {
            try {
                const res = await fetch("story.json");
                storyData = await res.json();

// Preload images
const imageUrls = storyData
    .filter(scene => scene.image)
    .map(scene => scene.image);
preloadImages(imageUrls);


                const urls = [];

storyData.forEach(scene => {
  if (scene.audio) urls.push(scene.audio);
  if (scene.multiAudio) {
    for (let key in scene.multiAudio) {
      urls.push(scene.multiAudio[key]);
    }
  }
});

const uniqueUrls = [...new Set(urls)];
for (let url of uniqueUrls) {
    buffers[url] = await loadAudio(url);
}

                const start = storyData.find(s => s.name === "START");

                const startText = (start?.text || 'Welcome adventurer...')
                    .replace(/\n/g, '<br>')
                    .replace(/\[\[.*?\]\]/g, '');

                document.getElementById("game").innerHTML = `
  <div class="image-text-container">
    ${start?.image ? `<img src="${start.image}" alt="" class="fade-in" onload="this.classList.add('loaded')">` : ''}
    <div class="text-block">${startText}</div>
  </div>
  <div class="button" onclick="startScene()">BEGIN YOUR ADVENTURE</div>
`;
            } catch (err) {
                document.getElementById("game").innerHTML = `<p>❌ Failed to load story.json<br>${err}</p>`;
                console.error(err);
            }
        }

        function startScene() {
            showScene("BEGIN YOUR ADVENTURE");
        }

        loadStory();
    
let multiAudioSources = {};
let multiAudioGains = {};
let currentMultiAudio = null;


async function playMultiAudio(multiAudioMap, onEnded) {
    stopAudio(); // stop regular audio
    stopMultiAudio(); // stop any previous multiaudio
    multiAudioSources = {};
    multiAudioGains = {};

    const labels = Object.keys(multiAudioMap || {});
    if (labels.length === 0) return;

    const now = audioContext.currentTime;
    const startTime = now;
    const promises = [];

    for (let label of labels) {
        const url = multiAudioMap[label];
        const promise = loadAudio(url).then(buffer => {
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.loop = true;

            const gainNode = audioContext.createGain();
            gainNode.gain.value = 0;

            source.connect(gainNode).connect(audioContext.destination);
            multiAudioSources[label] = source;
            multiAudioGains[label] = gainNode;
        });
        promises.push(promise);
    }

    await Promise.all(promises);

    Object.values(multiAudioSources).forEach(src => src.start(0));
    currentMultiAudio = true;
    const firstTrack = Object.keys(multiAudioSources)[0];
    if (firstTrack) {
        multiAudioGains[firstTrack].gain.setValueAtTime(1, audioContext.currentTime);
    }

    if (onEnded) {
        // Attach ended callback to all sources
        Object.values(multiAudioSources).forEach(source => {
            source.onended = onEnded;
        });
    }
}


function stopMultiAudio() {
    for (let label in multiAudioSources) {
        try { multiAudioSources[label].stop(); } catch (e) {}
        multiAudioSources[label].disconnect();
    }
    multiAudioSources = {};
    multiAudioGains = {};
    currentMultiAudio = null;
}

function switchToTrack(label) {
    if (!multiAudioGains[label]) return;
    for (let l in multiAudioGains) {
        multiAudioGains[l].gain.setTargetAtTime(l === label ? 1 : 0, audioContext.currentTime, 0.1);
    }
}

</script>



</body>

</html>