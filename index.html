<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>The Stupid Saloon Cyborg Band</title>
    <style>
        /* [SNIPPED STYLES: all your existing CSS is untouched] */
    </style>
</head>

<body>
    <div id="game">
        <p>Loading story...</p>
    </div>

    <script>
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let buffers = {};
        let currentSource = null;
        let choiceMade = null;
        let isLoopingScene = false;
        let currentScene = null;
        let storyData = [];
        let visitedImages = [];

        function showScene(sceneId) {
            const scene = storyData.find(s => s.id === sceneId || s.name === sceneId);
            if (!scene) {
                document.getElementById("game").innerHTML = `<p>‚ùå Scene not found: ${sceneId}</p>`;
                return;
            }
            currentScene = scene;
            if (scene.image && !visitedImages.includes(scene.image)) {
                visitedImages.push(scene.image);
                console.log("Tracked image:", scene.image);
            }

            let html = '';

            if (scene.image || scene.text) {
                const cleanText = scene.text ? scene.text.replace(/\[\[.*?\]\]/g, '') : '';
                html += `
                    <div class="image-text-container">
                        ${scene.image ? `<img src="${scene.image}" alt="" class="fade-in" onload="this.classList.add('loaded')">` : ''}
                        <div class="text-block">
                            ${scene.scrollText === true
                    ? `<div class="scrolling-container">
                                <div class="slideshow-container left-fixed"><img id="slideshowImage1" class="slideshow-image" src=""></div>
                                <div class="slideshow-container right"><img id="slideshowImage2" class="slideshow-image" src=""></div>
                                <div class="scrolling-inner">${cleanText}</div>
                            </div>`
                    : cleanText}
                        </div>
                    </div>
                `;
            }

            if (scene.choices && scene.choices.length > 0) {
                scene.choices.forEach(choice => {
                    html += `<div class="button" onclick="handleChoice('${choice.next}')">${choice.label}</div>`;
                });
            }

            // ‚úÖ Comic button for endings
            if (!scene.choices || scene.choices.length === 0) {
                html += `<div class="button" onclick="downloadComic()">üìÑ Download Your Adventure Comic</div>`;
            }

            if (scene.multiAudio) {
                isLoopingScene = true;
                playMultiAudio(scene.multiAudio, () => {
                    if (choiceMade) {
                        showScene(choiceMade);
                        choiceMade = null;
                    }
                });
                const switcherButtons = Object.keys(scene.multiAudio).map(label =>
                    `<button class='button' onclick="switchToTrack('${label}')">Switch to ${label}</button>`
                ).join("");
                html += "<div style='margin-top:1em'>" + switcherButtons + "</div>";
            }

            document.getElementById("game").innerHTML = html;
        }

        function downloadComic() {
            console.log("Download comic triggered. (function placeholder)");
            // Add comic PDF logic here
        }
    </script>

    <script src="https://unpkg.com/pdf-lib"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvg@3.0.10/lib/umd.min.js"></script>
</body>

</html>
