<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>The Stupid Saloon Cyborg Band</title>
    <style>
        
        @font-face {
            font-family: 'IM Fell English';
            src: url('IMFellEnglish.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }

        body,
        #text,
        button,
        .prompt,
        .option,
        .title {
            font-family: 'IM Fell English', serif !important;
        }

        body {
            font-family: "IM Fell English", serif;
            background: black;
            color: white;
            text-align: center;
            padding: 2em;
            font-size: 1.5em;
        }

        img {
            max-width: 90%;
            height: auto;
            margin-bottom: 1em;
        }

        .button {
            display: inline-block;
            background: linear-gradient(to bottom, #3e2f23, #2a1f16);
            border: 1px solid #a57c57;
            border-radius: 4px;
            color: #f4e7d0;
            font-family: 'IM Fell English', serif;
            letter-spacing: 0.5px;
            padding: 10px 16px;
            margin: 1em;
            cursor: pointer;
            box-shadow: inset 0 0 4px #00000088, 0 0 6px #3defff44;
            transition: all 0.2s ease-in-out;
            font-size: 1em;
        }

        .button:hover {
            background: #4c372a;
            border-color: #ffc56f;
            box-shadow: inset 0 0 6px #000000aa, 0 0 10px #00ffe655;
            transform: translateY(-1px);
        }

        .button:active {
            transform: scale(0.97);
            box-shadow: inset 0 0 3px #000000cc, 0 0 4px #ffaa0088;
        }

        .button.waiting {
            animation: pulse 1.2s ease-in-out infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 6px #3defff33;
                background-color: #3e2f23;
            }

            50% {
                box-shadow: 0 0 20px #3defffbb;
                background-color: #4c372a;
            }

            100% {
                box-shadow: 0 0 6px #3defff33;
                background-color: #3e2f23;
            }
        }

        .image-text-container {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            gap: 2em;
            margin-bottom: 1.5em;
            flex-wrap: wrap;
        }

        .image-text-container img {
            max-width: 100%;
            height: auto;
        }

        .text-block {
            max-width: 600px;
            text-align: left;
        }

        @media (max-width: 768px) {
            .image-text-container {
                flex-direction: column;
                align-items: center;
                gap: 2.5em;
            }

            .text-block {
                text-align: center;
            }

            .button {
                padding: 12px 20px;
                font-size: 1.25em;
            }

            body {
                font-size: 1.875em;
            }
        }

        .fade-in {
            opacity: 0;
            transition: opacity 0.8s ease-in;
        }

        .fade-in.loaded {
            opacity: 0.4;
        }

        .scrolling-container {
            height: 300px;
            overflow: hidden;
            position: relative;
            width: 100%;
            margin: 2em auto;
        }

        .scrolling-inner {
            position: relative;
            text-align: center;
            white-space: pre-line;
        }

        .slideshow-container {
            position: fixed;
            max-height: 400px;
            width: 400px;
            pointer-events: none;
            z-index: 0;
            animation: floatUp 6s ease-in-out infinite alternate;
        }

        .slideshow-container.left-fixed {
            left: 60px;
        }

        .slideshow-container.right {
            right: 60px;
        }

        .slideshow-image {
            max-height: 400px;
            width: auto;
            opacity: 0;
            transition: opacity 4s ease-in-out;
        }

        .slideshow-image.visible {
            opacity: 0.4;
        }

        @keyframes floatUp {
            0% { transform: translateY(0); }
            100% { transform: translateY(-20px); }
        }

        @keyframes floatDown {
            0% { transform: translateY(0); }
            100% { transform: translateY(20px); }
        }

        @keyframes floatLeft {
            0% { transform: translateX(0); }
            100% { transform: translateX(-20px); }
        }

        @keyframes floatRight {
            0% { transform: translateX(0); }
            100% { transform: translateX(20px); }
        }

        @keyframes floatDiagonalLeft {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-20px, -20px); }
        }

        @keyframes floatDiagonalRight {
            0% { transform: translate(0, 0); }
            100% { transform: translate(20px, -20px); }
        }

        .floatUp { animation: floatUp 6s ease-in-out infinite alternate; }
        .floatDown { animation: floatDown 6s ease-in-out infinite alternate; }
        .floatLeft { animation: floatLeft 6s ease-in-out infinite alternate; }
        .floatRight { animation: floatRight 6s ease-in-out infinite alternate; }
        .floatDiagonalLeft { animation: floatDiagonalLeft 6s ease-in-out infinite alternate; }
        .floatDiagonalRight { animation: floatDiagonalRight 6s ease-in-out infinite alternate; }

    </style>
</head>

<body>
    <div id="game">
        <p>Loading story...</p>
    </div>

    <script>
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let buffers = {};
        let currentSource = null;
        let choiceMade = null;
        let isLoopingScene = false;
        let currentScene = null;
        let storyData = [];
        let visitedImages = [];

        function showScene(sceneId) {
            const scene = storyData.find(s => s.id === sceneId || s.name === sceneId);
            if (!scene) {
                document.getElementById("game").innerHTML = `<p>‚ùå Scene not found: ${sceneId}</p>`;
                return;
            }
            currentScene = scene;
            if (scene.image && !visitedImages.includes(scene.image)) {
                visitedImages.push(scene.image);
                console.log("Tracked image:", scene.image);
            }

            let html = '';

            if (scene.image || scene.text) {
                const cleanText = scene.text ? scene.text.replace(/\[\[.*?\]\]/g, '') : '';
                html += `
                    <div class="image-text-container">
                        ${scene.image ? `<img src="${scene.image}" alt="" class="fade-in" onload="this.classList.add('loaded')">` : ''}
                        <div class="text-block">
                            ${scene.scrollText === true
                    ? `<div class="scrolling-container">
                                <div class="slideshow-container left-fixed"><img id="slideshowImage1" class="slideshow-image" src=""></div>
                                <div class="slideshow-container right"><img id="slideshowImage2" class="slideshow-image" src=""></div>
                                <div class="scrolling-inner">${cleanText}</div>
                            </div>`
                    : cleanText}
                        </div>
                    </div>
                `;
            }

            if (scene.choices && scene.choices.length > 0) {
                scene.choices.forEach(choice => {
                    html += `<div class="button" onclick="handleChoice('${choice.next}')">${choice.label}</div>`;
                });
            }

            // ‚úÖ Comic button for endings
            if (!scene.choices || scene.choices.length === 0) {
                html += `<div class="button" onclick="downloadComic()">üìÑ Download Your Adventure Comic</div>`;
            }

            if (scene.multiAudio) {
                isLoopingScene = true;
                playMultiAudio(scene.multiAudio, () => {
                    if (choiceMade) {
                        showScene(choiceMade);
                        choiceMade = null;
                    }
                });
                const switcherButtons = Object.keys(scene.multiAudio).map(label =>
                    `<button class='button' onclick="switchToTrack('${label}')">Switch to ${label}</button>`
                ).join("");
                html += "<div style='margin-top:1em'>" + switcherButtons + "</div>";
            }

            document.getElementById("game").innerHTML = html;
        }

        function downloadComic() {
            console.log("Download comic triggered. (function placeholder)");
            // Add comic PDF logic here
        }
    </script>

    <script src="https://unpkg.com/pdf-lib"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvg@3.0.10/lib/umd.min.js"></script>
</body>

</html>
