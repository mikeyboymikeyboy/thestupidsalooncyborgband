<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>The Stupid Saloon Cyborg Band</title>
    <script src="https://cdn.jsdelivr.net/npm/svg2pdf.js@2.1.4/dist/svg2pdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @font-face {
            font-family: 'IM Fell English';
            src: url('IMFellEnglish.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }

        body,
        #text,
        button,
        .prompt,
        .option,
        .title {
            font-family: 'IM Fell English', serif !important;
        }

        body {
            font-family: "IM Fell English", serif;
            background: black;
            color: white;
            text-align: center;
            padding: 2em;
            font-size: 1.5em;
        }

        img {
            max-width: 90%;
            height: auto;
            margin-bottom: 1em;
        }

        .button {
            display: inline-block;
            background: linear-gradient(to bottom, #3e2f23, #2a1f16);
            border: 1px solid #a57c57;
            border-radius: 4px;
            color: #f4e7d0;
            font-family: 'IM Fell English', serif;
            letter-spacing: 0.5px;
            padding: 10px 16px;
            margin: 1em;
            cursor: pointer;
            box-shadow: inset 0 0 4px #00000088, 0 0 6px #3defff44;
            transition: all 0.2s ease-in-out;
            font-size: 1em;
        }

        .button:hover {
            background: #4c372a;
            border-color: #ffc56f;
            box-shadow: inset 0 0 6px #000000aa, 0 0 10px #00ffe655;
            transform: translateY(-1px);
        }

        .button:active {
            transform: scale(0.97);
            box-shadow: inset 0 0 3px #000000cc, 0 0 4px #ffaa0088;
        }

        .button.waiting {
            animation: pulse 1.2s ease-in-out infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 6px #3defff33;
                background-color: #3e2f23;
            }

            50% {
                box-shadow: 0 0 20px #3defffbb;
                background-color: #4c372a;
            }

            100% {
                box-shadow: 0 0 6px #3defff33;
                background-color: #3e2f23;
            }
        }

        .image-text-container {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            gap: 2em;
            margin-bottom: 1.5em;
            flex-wrap: wrap;
        }

        .image-text-container img {
            max-width: 100%;
            height: auto;
        }

        .text-block {
            max-width: 600px;
            text-align: left;
        }

        @media (max-width: 768px) {
            .image-text-container {
                flex-direction: column;
                align-items: center;
            }

            .text-block {
                text-align: center;
            }
        }

        @media (max-width: 768px) {
            body {
                font-size: 1.875em;
                /* 25% bigger than original 1.5em */
            }

            .image-text-container {
                flex-direction: column;
                align-items: center;
                gap: 2.5em;
            }

            .text-block {
                text-align: center;
            }

            .button {
                padding: 12px 20px;
                font-size: 1.25em;
            }
        }

        .fade-in {
            opacity: 0;
            transition: opacity 0.8s ease-in;
        }

        .fade-in.loaded {
            opacity: 0.4;
        }

        .scrolling-container {
            height: 300px;
            overflow: hidden;
            position: relative;
            width: 100%;
            margin: 2em auto;
        }

        .scrolling-inner {
            position: relative;
            text-align: center;
            white-space: pre-line;
        }

        .scrolling-preview {
            position: absolute;

            left: 10px;
            z-index: 5;
            pointer-events: none;
        }

        .scrolling-preview img {
            max-height: 200px;
            border: 2px solid red;
            opacity: 0.4;
        }

        .slideshow-container {
            position: fixed;

            max-height: 400px;
            width: 400px;
            pointer-events: none;
            z-index: 0;
            animation: floatUp 6s ease-in-out infinite alternate;
        }

        .slideshow-container.left-fixed {
            left: 60px;
        }

        .slideshow-container.right {
            right: 60px;
        }

        .slideshow-image {
            max-height: 400px;
            width: auto;
            opacity: 0;
            transition: opacity 4s ease-in-out;
        }

        .slideshow-image.visible {
            opacity: 0.4;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0);
            }

            100% {
                transform: translateY(-20px);
            }
        }

        @keyframes floatDown {
            0% {
                transform: translateY(0);
            }

            100% {
                transform: translateY(20px);
            }
        }

        @keyframes floatLeft {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-20px);
            }
        }

        @keyframes floatRight {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(20px);
            }
        }

        @keyframes floatDiagonalLeft {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(-20px, -20px);
            }
        }

        @keyframes floatDiagonalRight {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(20px, -20px);
            }
        }

        .floatUp {
            animation: floatUp 6s ease-in-out infinite alternate;
        }

        .floatDown {
            animation: floatDown 6s ease-in-out infinite alternate;
        }

        .floatLeft {
            animation: floatLeft 6s ease-in-out infinite alternate;
        }

        .floatRight {
            animation: floatRight 6s ease-in-out infinite alternate;
        }

        .floatDiagonalLeft {
            animation: floatDiagonalLeft 6s ease-in-out infinite alternate;
        }

        .floatDiagonalRight {
            animation: floatDiagonalRight 6s ease-in-out infinite alternate;
        }
    </style>
</head>

<body>

    <div id="game">
        <p>Loading story...</p>
    </div>
    <div id="comic-export-container" style="display:none;"></div>
    <script>
        const gameDiv = document.getElementById('game');
        let storyData;
        let currentScene;
        let currentAudio;
        let currentSource;
        let audioContext;
        let buffers = {};
        let choiceMade = null;
        let isLoopingScene = false;
        let images = []; // Track images

        function generateComicSVG(images) {
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("width", "210mm");
            svg.setAttribute("height", "297mm");
            svg.setAttribute("viewBox", "0 0 2048 2860");

            images.slice(0, 5).forEach((url, i) => {
                const img = document.createElementNS(svgNS, "image");
                img.setAttributeNS(null, "href", url);
                img.setAttributeNS(null, "preserveAspectRatio", "xMidYMid slice");
                if (i === 0) img.setAttribute("x", -76), img.setAttribute("y", 169), img.setAttribute("width", 1110), img.setAttribute("height", 992);
                if (i === 1) img.setAttribute("x", 436), img.setAttribute("y", 170), img.setAttribute("width", 1756), img.setAttribute("height", 993);
                if (i === 2) img.setAttribute("x", 1183), img.setAttribute("y", 1027), img.setAttribute("width", 939), img.setAttribute("height", 1118);
                if (i === 3) img.setAttribute("x", -101), img.setAttribute("y", 1014), img.setAttribute("width", 1442), img.setAttribute("height", 1291);
                if (i === 4) img.setAttribute("x", -184), img.setAttribute("y", 1922), img.setAttribute("width", 2431), img.setAttribute("height", 1022);
                svg.appendChild(img);
            });

            return svg;
        }

        function exportComicPDF(images) {
            console.log("üí• Comic export triggered!", images);
            const container = document.getElementById("comic-export-container");
            container.innerHTML = '';
            const svg = generateComicSVG(images);
            container.appendChild(svg);

            setTimeout(() => {
                const jsPDF = window.jspdf?.jsPDF;
                const svg2pdf = window["svg2pdf"];
                if (!jsPDF || !svg2pdf) {
                    console.error("‚ùå PDF export libraries not loaded");
                    return;
                }

                const pdf = new jsPDF({
                    orientation: "portrait",
                    unit: "pt",
                    format: "a4"
                });

                svg2pdf(svg, pdf, {
                        xOffset: 0,
                        yOffset: 0,
                        scale: 0.25
                    })
                    .then(() => {
                        console.log("üìÑ PDF ready, saving...");
                        pdf.save("your-cybersaloon-comic.pdf");
                    })
                    .catch(err => console.error("‚ö†Ô∏è PDF generation failed:", err));
            }, 500);
        }

        async function loadAudio(url) {
            if (!audioContext) {
                try {
                    window.AudioContext = window.AudioContext || window.webkitAudioContext;
                    audioContext = new AudioContext();
                } catch (e) {
                    alert('Web Audio API is not supported in this browser');
                }
            }
            if (buffers[url]) return buffers[url];
            const res = await fetch(url);
            const buffer = await res.arrayBuffer();
            return await audioContext.decodeAudioData(buffer);
        }

        function playAudio(url, loop, onEnded) {
            stopAudio();
            if (!url) return;
            loadAudio(url).then(buffer => {
                currentSource = audioContext.createBufferSource();
                currentSource.buffer = buffer;
                currentSource.loop = loop;
                currentSource.connect(audioContext.destination);
                currentSource.start(0);
                currentAudio = url;
                if (onEnded) currentSource.onended = onEnded;
            });
        }

        function stopAudio() {
            if (currentSource) {
                try {
                    currentSource.stop();
                } catch (e) {}
                currentSource.disconnect();
                currentSource = null;
                currentAudio = null;
            }
        }

        function showScene(sceneId) {
            stopAudio();
            stopMultiAudio();
            currentScene = storyData.find(s => s.name === sceneId);
            if (!currentScene) {
                gameDiv.innerHTML = `<p>‚ùå Scene "${sceneId}" not found in story.json</p>`;
                return;
            }

            let text = currentScene.text.replace(/\n/g, '<br>');
            const prompt = text.match(/\[\[.*?\]\]/g);
            if (prompt) {
                text = text.replace(/\[\[.*?\]\]/g, `<span class="prompt">${prompt[0].slice(2, -2)}</span>`);
            }

            let choicesHtml = '';
            if (currentScene.choices) {
                choicesHtml = currentScene.choices
                    .map(choice => `<div class="button" onclick="handleChoice('<span class="math-inline">\{choice\.next\}'\)"\></span>{choice.label}</div>`)
                    .join('');
            }

            let imageHtml = currentScene.image ? `<img src="${currentScene.image}" alt="" class="fade-in" onload="this.classList.add('loaded')">` : '';

            let scrollTextHtml = currentScene.scrollText ? `<div class="scrolling-container"><div class="scrolling-inner">${text}</div></div>` : `<div class="text-block">${text}</div>`;

            gameDiv.innerHTML = `
        <div class="image-text-container">
          ${imageHtml}
          ${scrollTextHtml}
        </div>
        ${choicesHtml}
      `;

            // Add image to the tracking array
            if (currentScene.image) {
                images.push(currentScene.image);
            }

            // Show export button at "dead ends" (scenes with no choices)
            if (currentScene.choices.length === 0) {
                const exportButton = document.createElement('div');
                exportButton.classList.add('button');
                exportButton.textContent = 'Export Comic PDF